version: "3.7"

#####################################################
# Environment variables
# --------------------------
# HTTP_PORT - Default: 80
# HTTPS_PORT - Default: 443
# SITE_ADDRESS - Default: 'localhost' - Hostname on which ceiled-web will be hosted. Append ':80' to explicitly disable HTTPS.
# API_ADDRESS - Default: 'api.localhost' - Hostname on which the ceiled API will be hosted. Append ':80' to explicitly disable HTTPS.
#####################################################

services:

  driver:
    image: ceiled-driver:latest
    build: ./ceiled-driver
    restart: unless-stopped
    environment:
      ARGS: --debug --socketFile /app/socket/ceiled.sock
    stdin_open: true
    tty: true
    volumes:
      - ceiled-driver:/app/socket
    
  mongodb:
    image: mongo:4.2
    restart: unless-stopped
    expose:
      - 27017
    volumes:
      - mongodb:/data/db

  server:
    image: ceiled-server:latest
    build: ./ceiled-server
    restart: unless-stopped
    depends_on:
      - driver
      - mongodb
    ports: # TODO: only expose to host if API_ADDRESS specifies a port.
      - 6565:6565
    volumes:
      - ceiled-driver:/app/ceiled-driver
    environment:
      PORT: 6565
      CEILED_SOCKET: app/ceiled-driver/ceiled.sock
      INSECURE: "true"
      DB_HOST: mongodb
      
  web:
    image: ceiled-web:latest
    build: 
      context: ./ceiled-web
      args: 
        # TODO: make this default to 'api.' + SITE_ADDRESS if SITE_ADDRESS is localhost or a domain name,
        # and SITE_ADDRESS + ':6565' if SITE_ADDRESS is an IP.
        api_address: ${API_ADDRESS:-api.localhost}
    
    restart: unless-stopped
    ports:
      - ${HTTP_PORT:-80}:80
      - ${HTTPS_PORT:-443}:443
    volumes:
      - caddy-data:/data
    environment:
      SERVER_ADDRESS: http://server:6565
      SITE_ADDRESS: ${SITE_ADDRESS:-localhost}
    

volumes:
  ceiled-driver:
  caddy-data:
  mongodb:
