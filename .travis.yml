stages:
  - build
  - test
  - deploy

jobs:
  include:
    - language: node_js
      node_js:
        - 10
      cache: yarn
      name: Build ceiled-server
      stage: build
      before_install: cd ceiled-server
      install: yarn install
      script: yarn build

    - language: node_js
      node_js:
        - 10
      cache: yarn
      name: Build ceiled-web
      stage: build
      before_install: cd ceiled-web
      install: yarn install
      script: yarn build

    - language: node_js
      node_js:
        - 10
      cache: yarn
      name: Test ceiled-server
      stage: test
      before_install: cd ceiled-server
      install: yarn install
      script: yarn test
      services: 
        - mongodb

    - language: node_js
      node_js:
        - 10
      cache: yarn
      name: Deploy ceiled-driver, ceiled-server and ceiled-web
      stage: deploy
      if: branch = master OR branch = develop
      before_install:
        - openssl aes-256-cbc -K $encrypted_8913863055d3_key -iv $encrypted_8913863055d3_iv -in .travis/travis_key.enc -out ~/.ssh/travis_key -d
        - chmod 600 ~/.ssh/travis_key
        - echo "bart.vanoort.is ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBDpIvXSvLobd5l7nlTVGPcH6kjDrQZga40RkHVdh1RQH7Z4btuNhjwfZyjtCM4aeTPHWx7Qi15FJaUdvknWR1CU=" >> ~/.ssh/known_hosts
      install: cd ceiled-web && yarn install
      script: yarn build
      deploy:
        skip_cleanup: true
        provider: script
        script: cd .. && .travis/deploy.sh
        on:
          all_branches: true
          condition: $TRAVIS_BRANCH =~ ^develop|master$
    
    - language: rust
      rust: stable
      cache: cargo
      name: "Build ceiled-driver"
      stage: build
      before_script: cd ceiled-driver
      script: cargo build --verbose

    - language: rust
      rust: stable
      cache: cargo
      name: "Test ceiled-driver"
      stage: test
      before_script: cd ceiled-driver
      script: cargo test
